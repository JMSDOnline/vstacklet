#!/bin/bash
################################################################################
# <START METADATA>
# @file_name: vs-backup
# @version: 3.1.1124
# @description: This script will allow you to backup your vStacklet server
# files and databases.
# VS-Backup can be used on any server to backup files, directories and mysql
# databases, but it is designed to work with the vStacklet server stack.
# This script will backup your database and files.
# Please ensure you have read the documentation before continuing.
#
# @project_name: vstacklet
#
# @path: bin/backup/vs-backup
#
# @brief: vStacklet Backup Script
#
# - [vStacklet Documentation](https://github.com/JMSDOnline/vstacklet/blob/development/docs/setup/vstacklet.sh.md)
# - [vStacklet Server Stack Documentation](https://github.com/JMSDOnline/vstacklet/blob/development/docs/setup/vstacklet-server-stack.sh.md)
#
# This script will do the following:
# - Backup your database.
# - Backup your files.
# - Compress the backup files. (default: tar.gz - for files and sql.gz - for database)
# - Automatically encrypt the backup files. (password: set to your database password by default - `-dbpass`)
# - Retain the backup files based on the retention options. (default: 7 days)
#
# #### options:
# | Short | Long                       | Description
# | ----- | -------------------------- | ------------------------------------------
# |  -db   | --database                 | Backup the database.
# |  -dbuser   | --database_user          | The database user.
# |  -dbpass   | --database_password      | The database password.
# |  -dbdbu   | --database_backup_directory   | The database destination backup directory. (default: /backup/databases)
# |  -dbtbu   | --database_temporary_directory  | The database temporary backup directory. (default: /tmp/vstacklet/backup/databases)
# |  -f   | --files                    | Backup files in the web root directory.
# |  -fdbu   | --file_backup_directory   | The files destination backup directory. (default: /backup/files)
# |  -ftbu   | --file_temporary_directory  | The files temporary backup directory. (default: /tmp/vstacklet/backup/files)
# |  -r   | --retention                | Retention options. (default: 7)
# |  -frpe   | --file_retention_path_extension  | Retention path extension for the files. (default: `tar.gz`)
# |  -dbrpe   | --database_retention_path_extension  | Retention path extension for the database. (default: `enc`)
# |  -h   | --help                     | Display the help menu.
# |  -V   | --version                  | Display the version.
#
# #### examples:
# ```bash
#  /opt/vstacklet/bin/backup/vs-backup -dbuser "root" -dbpass "password" -db "database" -f "/var/www/html"
# ```
#
# @save_tasks:
#  automated_versioning: true
#  automated_documentation: true
#
# @build_tasks:
#  automated_comment_strip: false
#  automated_encryption: false
#
# @author: Jason Matthews (JMSolo)
# @author_contact: https://github.com/JMSDOnline/vstacklet
#
# @license: MIT License (Included in LICENSE)
# Copyright (C) 2016-2023, Jason Matthews
# All rights reserved.
# <END METADATA>
################################################################################
# @name: vstacklet::environment::functions (2)
# @description: Stage various functions for the setup environment. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L71-L150)
# @break
##################################################################################
vstacklet::environment::functions() {
	vstacklet::shell::output() {
		declare shell_reset
		shell_reset=$(tput sgr0)
		if [[ -z ${shell_newline} ]]; then
			declare shell_newline="\n"
		else
			unset shell_newline
		fi
		if [[ -n ${shell_icon} && -n "$*" ]]; then
			declare shell_newline="\n"
		elif [[ -n ${shell_icon} && -z "$*" ]]; then
			unset shell_newline
		fi
		case "${shell_option}" in
		bold) shell_option=$(tput bold) ;;
		underline) shell_option=$(tput smul) ;;
		standout) shell_option=$(tput smso) ;;
		esac
		case "${shell_icon}" in
		arrow) shell_icon="➜ ${shell_reset}" ;;
		warning) shell_icon="⚠ warning: ${shell_reset}" && shell_warning="1" ;;
		check) shell_icon="✓ ${shell_reset}" ;;
		cross) shell_icon="✗ ${shell_reset}" ;;
		success) shell_icon="✓ success: ${shell_reset}" && shell_success="1" ;;
		error) shell_icon="✗ error: ${shell_reset}" && shell_error="1" ;;
		rollback) shell_icon="⎌ rollback: ${shell_reset}" && shell_rollback="1" ;;
		esac
		if [[ ${shell_success} == "1" ]]; then
			printf -- "${shell_reset}$(tput bold)${shell_color}${shell_icon}${shell_reset} ${output_color}%s${shell_newline}${shell_reset}" "$@"
		elif [[ ${shell_warning} == "1" ]]; then
			printf -- "${shell_reset}$(tput bold)${shell_color}${shell_icon}${shell_reset} ${output_color}%s${shell_newline}${shell_reset}" "$@"
		elif [[ ${shell_error} == "1" ]]; then
			printf -- "${shell_reset}$(tput bold)${shell_color}${shell_icon}${shell_reset} ${output_color}%s${shell_newline}${shell_reset}" "$@"
		elif [[ ${shell_rollback} == "1" ]]; then
			printf -- "${shell_reset}$(tput bold)${shell_color}${shell_icon}${shell_reset} ${output_color}%s${shell_newline}${shell_reset}" "$@"
		else
			printf -- "${shell_reset}${shell_color}${shell_icon}${shell_option}%s${shell_newline}${shell_reset}" "$@"
		fi
		unset shell_color shell_newline shell_option shell_icon
	}
	vstacklet::shell::misc::nl() {
		printf "\n"
	}
	vstacklet::shell::text::white() {
		declare -g shell_color
		shell_color=$(tput setaf 7)
		vstacklet::shell::output "$@"
	}
	vstacklet::shell::text::white::sl() {
		declare -g shell_color shell_newline=0
		shell_color=$(tput setaf 7)
		vstacklet::shell::output "$@"
	}
	vstacklet::shell::text::error() {
		declare -g shell_color shell_icon
		shell_color=$(tput setaf 1)
		shell_icon="error"
		output_color=$(tput setaf 7)
		vstacklet::shell::output "$@"
	}
	vstacklet::shell::text::success() {
		declare -g shell_color shell_icon
		shell_color=$(tput setaf 2)
		shell_icon="success"
		output_color=$(tput setaf 7)
		vstacklet::shell::output "$@"
	}
	vstacklet::shell::text::green() {
		declare -g shell_color
		shell_color=$(tput setaf 2)
		vstacklet::shell::output "$@"
	}
	vstacklet::shell::text::continue() {
		declare -g shell_color shell_icon
		shell_color=$(tput setaf 5)
		shell_icon="arrow"
		vstacklet::shell::output "$@"
	}
}

##################################################################################
# @name: vstacklet::environment::checkroot (1)
# @description: Check if the user is root. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L157-L162)
# @break
##################################################################################
vstacklet::environment::checkroot() {
	[[ $(whoami) != "root" ]] && {
		vstacklet::shell::text::error "you must be root to run this script."
		exit 1
	}
}

##################################################################################
# @name: vstacklet::backup::variables (3)
# @description: Set the variables for the backup. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L169-L294)
# @break
##################################################################################
vstacklet::backup::variables() {
	HELP="${HELP:-false}"
	VERSION="${VERSION:-false}"
	while [ $# -gt 0 ]; do
		case "${1}" in
		-V | --version)
			VERSION=true
			shift
			;;
		-h | --help)
			HELP=true
			shift
			;;
		-ec | --example_cron)
			vstacklet::backup::example_cron
			exit 0
			;;
		### FILES/DIRECTORIES TO BACKUP
		-fdbu | --file_backup_directory)
			DESTINATION="${2}"
			shift
			shift
			;;
		-ftbu | --file_temporary_directory)
			TEMPORARY="${2}"
			shift
			shift
			;;
		-f | --file)
			FILE="${2}"
			shift
			shift
			;;
		### MYSQL TO BACKUP
		-dbtbu | --database_temporary_directory)
			DB_TMP_DIR_DEST="${2}"
			shift
			shift
			;;
		-dbdbu | --database_backup_directory)
			DB_DIR_DEST="${2}"
			shift
			shift
			;;
		-db | --database)
			DB="${2}"
			shift
			shift
			;;
		-dbuser | --database_user)
			DB_USER="${2}"
			shift
			shift
			;;
		-dbpass | --database_password)
			DB_PASS="${2}"
			shift
			shift
			;;
		-dblist | --database_list)
			DB_LIST=("${2}")
			shift
			shift
			;;
		-dbop | --database_options)
			DB_OPTIONS="${2}"
			shift
			shift
			;;
		-dbdop | --database_dump_options)
			DB_DUMP_OPTIONS="${2}"
			shift
			shift
			;;
		-c | --compression)
			COMPRESSION="${2}"
			shift
			shift
			;;
		-co | --compression_options)
			COMPRESSION_OPTIONS="${2}"
			shift
			shift
			;;
		-r | --retention)
			RETENTION="${2}"
			shift
			shift
			;;
		-frp | --file_retention_path)
			FILE_RETENTION_PATH="${2}"
			shift
			shift
			;;
		-frpe | --file_retention_path_extension)
			FILE_RETENTION_PATH_EXTENSION="${2}"
			shift
			shift
			;;
		-dbrp | --database_retention_path)
			DB_RETENTION_PATH="${2}"
			shift
			shift
			;;
		-dbrpe | --database_retention_path_extension)
			DB_RETENTION_PATH_EXTENSION="${2}"
			shift
			shift
			;;
		*)
			vstacklet::shell::text::error "Invalid argument: ${1}"
			vstacklet::shell::misc::nl
			vstacklet::backup::usage
			exit 1
			;;
		esac
	done
	# check if the user wants to see the version
	if [[ ${VERSION} == "true" ]]; then
		vstacklet::backup::version
	fi
	# check if the user wants to see the help
	if [[ ${HELP} == "true" ]]; then
		vstacklet::backup::usage
	fi
}

##################################################################################
# @name: vstacklet::backup::default::variables (4)
# @description: The variables used in the backup script. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L301-L347)
# @break
##################################################################################
vstacklet::backup::default::variables() {
	### FILES/DIRECTORIES TO BACKUP
	F_TMP_DIR_DEST="${F_TMP_DIR_DEST:-/tmp/vstacklet/backup/files}"
	F_DIR_DEST="${F_DIR_DEST:-/backup/files}"
	DIR_BFILES="${DIR_BFILES:-/var/www/html}"
	F_PACKAGE="${F_PACKAGE:-$(date +%Y-%m-%d-%H-%M-%S).tar.gz}"
	DESTINATION="${DESTINATION:-false}"
	TEMPORARY="${TEMPORARY:-false}"
	FILE="${FILE:-false}"
	### MYSQL TO BACKUP
	# set the date stamp format
	DATE_STAMP=$(date +%Y-%m-%d-%H-%M-%S)
	# set the backup directory
	DB_DIR_DEST="${DB_DIR_DEST:-/backup/databases/}"
	# set the temporary directory
	DB_TMP_DIR_DEST="${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}"
	# set the backup file name
	BACKUP_FILE="${BACKUP_FILE:-${DATE_STAMP}.sql}"
	# set the destination backup file path
	BACKUP_FILE_PATH="${DB_DIR_DEST}${BACKUP_FILE}"
	# set the temporary backup file path
	BACKUP_FILE_PATH_TMP="${DB_TMP_DIR_DEST}${BACKUP_FILE}"
	# set the database list
	DB_LIST=("${DB_LIST:-$(mysql -e "show databases;" | grep -Ev "(Database|information_schema|performance_schema|phpmyadmin|mysql|sys)")}")
	# set the database user
	DB_USER="${DB_USER:-root}"
	# set the database password
	DB_PASS="${DB_PASS:-$(grep 'password' <'/root/.my.cnf' | awk -F'=' '{print $2}' | head -n 1)}"
	# set the database options
	DB_OPTIONS="${DB_OPTIONS:---opt}"
	# set the database dump options
	DB_DUMP_OPTIONS="${DB_DUMP_OPTIONS:---add-drop-table --lock-tables --databases}"
	# set the backup file compression
	COMPRESSION="${COMPRESSION:-gzip}"
	# set the backup file compression options
	COMPRESSION_OPTIONS="${COMPRESSION_OPTIONS:--9}"
	# set the backup file retention
	RETENTION="${RETENTION:-7}"
	# set the backup file retention path
	FILE_RETENTION_PATH="${FILE_RETENTION_PATH:-${F_DIR_DEST}}"
	# set the backup file retention path options for files
	FILE_RETENTION_PATH_EXTENSION="${FILE_RETENTION_PATH_EXTENSION:-tar.gz}"
	# set the database backup file retention path
	DB_RETENTION_PATH="${DB_RETENTION_PATH:-${DB_DIR_DEST}}"
	# set the backup file retention path options for databases
	DB_RETENTION_PATH_EXTENSION="${DB_RETENTION_PATH_EXTENSION:-enc}"
}

##################################################################################
# @name: vstacklet::backup::main::checks (5)
# @description: The checks used in the backup script. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L354-L395)
# @break
##################################################################################
vstacklet::backup::main::checks() {
	### FILES/DIRECTORIES TO BACKUP
	# check if the destination directory flag was set
	[ "${DESTINATION}" != false ] && F_DIR_DEST="${DESTINATION}"
	# check if the temporary directory flag was set
	[ "${TEMPORARY}" != false ] && F_TMP_DIR_DEST="${TEMPORARY}"
	# check if the file flag was set
	[ "${FILE}" != false ] && DIR_BFILES="${FILE}"
	### MYSQL TO BACKUP
	# check if the destination backup file exists
	[[ -f "${BACKUP_FILE_PATH}" ]] && { vstacklet::shell::text::error "The backup file ${BACKUP_FILE_PATH} already exists." && exit 1; }
	# check if the temporary backup file exists
	[[ -f "${BACKUP_FILE_PATH_TMP}" ]] && { vstacklet::shell::text::error "The backup file ${BACKUP_FILE_PATH_TMP} already exists." && exit 1; }
	# check if the database list is empty
	[[ -z "${DB_LIST[*]}" ]] && { vstacklet::shell::text::error "The database list is empty." && exit 1; }
	# check if either the database or the database list is empty
	[[ -z "${DB}" && -z "${DB_LIST[*]}" ]] && { vstacklet::shell::text::error "The database or the database list is empty." && exit 1; }
	# if database is not empty, check if it exists in the database list
	[[ -n "${DB}" && ! " ${DB_LIST[*]} " =~ ${DB} ]] && { vstacklet::shell::text::error "The database ${DB} does not exist in the database list." && exit 1; }
	# check if the database user is empty
	[[ -z "${DB_USER}" ]] && { vstacklet::shell::text::error "The database user is empty." && exit 1; }
	# check if the database password is empty
	[[ -z "${DB_PASS}" ]] && { vstacklet::shell::text::error "The database password is empty." && exit 1; }
	# check if the database options is empty
	[[ -z "${DB_OPTIONS}" ]] && { vstacklet::shell::text::error "The database options is empty." && exit 1; }
	# check if the database dump options is empty
	[[ -z "${DB_DUMP_OPTIONS}" ]] && { vstacklet::shell::text::error "The database dump options is empty." && exit 1; }
	# check if the compression is empty
	[[ -z "${COMPRESSION}" ]] && { vstacklet::shell::text::error "The compression is empty." && exit 1; }
	# check if the compression options is empty
	[[ -z "${COMPRESSION_OPTIONS}" ]] && { vstacklet::shell::text::error "The compression options is empty." && exit 1; }
	# check if the retention is empty
	[[ -z "${RETENTION}" ]] && { vstacklet::shell::text::error "The retention is empty." && exit 1; }
	# check if the file retention path is empty
	[[ -z "${FILE_RETENTION_PATH}" ]] && { vstacklet::shell::text::error "The retention path is empty." && exit 1; }
	# check if the file retention path extension is empty
	[[ -z "${FILE_RETENTION_PATH_EXTENSION}" ]] && { vstacklet::shell::text::error "The file retention path extension is empty." && exit 1; }
	# check if the database retention path is empty
	[[ -z "${DB_RETENTION_PATH}" ]] && { vstacklet::shell::text::error "The retention path is empty." && exit 1; }
	# check if the database retention path extension is empty
	[[ -z "${DB_RETENTION_PATH_EXTENSION}" ]] && { vstacklet::shell::text::error "The database retention path extension is empty." && exit 1; }
}

##################################################################################
# @name: vstacklet::intro (6)
# @description: Prints the intro message. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L402-L419)
# @break
##################################################################################
vstacklet::intro() {
	vstacklet::shell::text::white "Welcome to the vStacklet Backup Utility."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "This script will allow you to backup your vStacklet server."
	vstacklet::shell::text::white "Please ensure you have read the documentation before continuing."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "Documentation can be found at:"
	vstacklet::shell::text::white "https://github.com/JMSDOnline/vstacklet/blob/development/docs/bin/backup/vs-backup.md"
	vstacklet::shell::misc::nl
	vstacklet::ask::continue
}

# shall we continue? function (6.a)
vstacklet::ask::continue() {
	vstacklet::shell::text::green "Press any key to continue $(tput setaf 7)(${shell_reset}$(tput setaf 3)ctrl+C${shell_reset} $(tput setaf 7)to ${shell_reset}$(tput setaf 1)exit${shell_reset}$(tput setaf 7)) ..."
	read -r -n 1
	vstacklet::shell::misc::nl
}

##################################################################################
# @name: vstacklet::backup::files (7)
# @description: Backup the specified files. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L426-L483)
# @break
##################################################################################
vstacklet::backup::files() {
	##################################################################################
	# @name: vstacklet::backup::file::directories (a)
	# @description: The directories for files used in the backup script.
	# note: The directories are created if they don't exist.
	##################################################################################
	if [[ ! -d "${F_TMP_DIR_DEST:-/tmp/vstacklet/backup/files}" ]] || [[ ! -d "${F_DIR_DEST:-/backup/files}" ]]; then
		vstacklet::shell::text::white "Creating backup directories for files..."
		mkdir -p "${F_TMP_DIR_DEST:-/tmp/vstacklet/backup/files}" 2>&1
		mkdir -p "${F_DIR_DEST:-/backup/files}" 2>&1
		# check if the destination directory exists
		[ ! -d "${F_DIR_DEST}" ] && vstacklet::shell::text::error "Destination directory does not exist: ${F_DIR_DEST}" && vstacklet::shell::misc::nl && exit 1
		# check if the temporary directory exists
		[ ! -d "${F_TMP_DIR_DEST}" ] && vstacklet::shell::text::error "Temporary directory does not exist: ${F_TMP_DIR_DEST}" && vstacklet::shell::misc::nl && exit 1
		# check if the backup source directory exists
		[ ! -d "${DIR_BFILES}" ] && vstacklet::shell::text::error "Backup source directory does not exist: ${DIR_BFILES}" && vstacklet::shell::misc::nl && exit 1
		vstacklet::shell::text::success "Backup directories created successfully."
		vstacklet::shell::misc::nl
	fi
	##################################################################################
	# @name: vstacklet::backup::file::checks (b)
	# @description: The checks for files used in the backup script.
	##################################################################################
	# check if the backup source directory is empty
	[ -z "$(ls -A "${DIR_BFILES}")" ] && vstacklet::shell::text::error "Backup source directory is empty: ${DIR_BFILES}" && vstacklet::shell::misc::nl && exit 1
	# check if the destination backup package exists
	[ -f "${F_DIR_DEST}/${F_PACKAGE}" ] && vstacklet::shell::text::error "Backup package already exists: ${F_DIR_DEST}/${F_PACKAGE}" && vstacklet::shell::misc::nl && exit 1
	# check if the temporary backup package exists
	[ -f "${F_TMP_DIR_DEST}/${F_PACKAGE}" ] && vstacklet::shell::text::error "Backup package already exists: ${F_TMP_DIR_DEST}/${F_PACKAGE}" && vstacklet::shell::misc::nl && exit 1
	##################################################################################
	# @name: vstacklet::backup::file::backup (c)
	# @description: The backup process for files used in the backup script.
	##################################################################################
	# create the backup package
	vstacklet::shell::text::white "Creating backup of ${DIR_BFILES}..."
	tar -czf "${F_TMP_DIR_DEST}/${F_PACKAGE}" -C "${DIR_BFILES}" .
	# check if the temporary backup package exists
	[ ! -f "${F_TMP_DIR_DEST}/${F_PACKAGE}" ] && vstacklet::shell::text::error "Temporary backup package does not exist: ${F_TMP_DIR_DEST}/${F_PACKAGE}" && vstacklet::shell::misc::nl && exit 1
	# check if the temporary backup package is empty
	[ -z "$(ls -A "${F_TMP_DIR_DEST}/${F_PACKAGE}")" ] && vstacklet::shell::text::error "Backup package is empty: ${F_TMP_DIR_DEST}/${F_PACKAGE}" && vstacklet::shell::misc::nl && exit 1
	# move the backup package to the destination directory
	vstacklet::shell::text::white "Moving backup of ${DIR_BFILES} to ${F_DIR_DEST}/${F_PACKAGE}..."
	\cp -f "${F_TMP_DIR_DEST}/${F_PACKAGE}" "${F_DIR_DEST}/${F_PACKAGE}"
	# check if the destination backup package exists
	[ ! -f "${F_DIR_DEST}/${F_PACKAGE}" ] && vstacklet::shell::text::error "Backup package does not exist: ${F_DIR_DEST}/${F_PACKAGE}" && vstacklet::shell::misc::nl && exit 1
	# check if the destination backup package is empty
	[ -z "$(ls -A "${F_DIR_DEST}/${F_PACKAGE}")" ] && vstacklet::shell::text::error "Backup package is empty: ${F_DIR_DEST}/${F_PACKAGE}" && vstacklet::shell::misc::nl && exit 1
	# check if the backup package is the correct size
	[ "$(stat -c%s "${F_DIR_DEST}/${F_PACKAGE}")" != "$(stat -c%s "${F_TMP_DIR_DEST}/${F_PACKAGE}")" ] && vstacklet::shell::text::error "Backup package is the incorrect size: ${F_DIR_DEST}/${F_PACKAGE}" && vstacklet::shell::misc::nl && exit 1
	# remove the backup package from the temporary directory
	rm -f "${F_TMP_DIR_DEST}/${F_PACKAGE}"
	##################################################################################
	# @name: vstacklet::backup::file::success (e)
	# @description: The backup process for files used in the backup script.
	##################################################################################
	vstacklet::shell::text::success "The backup of ${DIR_BFILES} was successful!"
	vstacklet::shell::misc::nl
}

################################################################################
# @name: vstacklet::backup::database (8)
# @description: Backup a database. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L503-L553)
#
# note: This function will additionally package the database backup into a tarball
# and compress it on the fly, then encrypt it. The tarball will be moved to the
# destination directory and the temporary directory will be cleaned up.
# - To decrypt the tarball, use the following command example: (replace the variables)
# ```
# openssl enc -d -pbkdf2 -in "${DB_DIR_DEST:-/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}.enc" -out "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}" -k "${DB_PASS}"
# ```
# - To extract the tarball, use the following command example: (replace the variables)
# ```
# tar -xzf "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}" -C "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}"
# ```
#
# @break
################################################################################
vstacklet::backup::database() {
	##################################################################################
	# @name: vstacklet::backup::db::directories (a)
	# @description: The directories for databases used in the backup script.
	# note: The directories are created if they don't exist.
	##################################################################################
	if [[ ! -d "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}" || ! -d "${DB_DIR_DEST:-/backup/databases/}" ]]; then
		vstacklet::shell::text::white "Creating backup directories for databases..."
		[[ ! -d "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}" ]] && mkdir -p "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}"
		[[ ! -d "${DB_DIR_DEST:-/backup/databases/}" ]] && mkdir -p "${DB_DIR_DEST:-/backup/databases/}"
		vstacklet::shell::text::success "Backup directories created successfully."
		vstacklet::shell::misc::nl
	fi
	##################################################################################
	# @name: vstacklet::backup::db::message (b)
	# @description: The message used in the backup script to display the backup status.
	##################################################################################
	vstacklet::shell::text::white "Backing up ${DB_LIST[*]} database(s) to ${DB_DIR_DEST}${DATE_STAMP}..."
	##################################################################################
	# @name: vstacklet::backup::db::backup (c)
	# @description: The backup loop function used in the backup script.
	##################################################################################
	for DB in "${DB_LIST[@]}"; do
		vstacklet::shell::text::white "Backing up ${DB}..."
		# Create the backup and compress it on the fly, then encrypt it.
		# shellcheck disable=SC2086
		mysqldump ${DB_OPTIONS} -u"${DB_USER}" -p"${DB_PASS}" ${DB} | ${COMPRESSION} ${COMPRESSION_OPTIONS} >"${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}" &&
			openssl enc -pbkdf2 -salt -in "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}" -out "${DB_DIR_DEST:-/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}.enc" -k "${DB_PASS}" &&
			rm -f "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}"
		# Check if the backup succeeded.
		#if [[ "${?}" -eq 0 ]]; then # use the below if statement instead of this one for proper success/failure reporting
		if [[ -f "${DB_DIR_DEST:-/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}.enc" ]]; then
			vstacklet::shell::text::success "The backup of ${DB} was successful!"
			vstacklet::shell::misc::nl
		else
			vstacklet::shell::text::error "The backup of ${DB} failed!"
			vstacklet::shell::misc::nl
		fi
	done
	##################################################################################
	# Decrypt the backup and decompress it on the fly.
	# note: This is an example of how to decrypt and decompress the backup
	# - dependency required: pv (pipe viewer) - https://www.ivarch.com/programs/pv.shtml
	#   - install with: `sudo apt-get install pv`
	##################################################################################
	#DECOMPRESSION="tar"
	#DECOMPRESSION_OPTIONS="-xzf"
	#openssl enc -d -pbkdf2 -in "${DB_DIR_DEST:-/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}.enc" -out "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}" -k "${DB_PASS}" &&
	#	${DECOMPRESSION} ${DECOMPRESSION_OPTIONS} "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}" &&
	#	rm -f "${DB_TMP_DIR_DEST:-/tmp/vstacklet/backup/databases/}${DB}.sql.${DATE_STAMP}${COMPRESSION_EXTENSION}"
}

##################################################################################
# @name: vstacklet::backup::retention (9)
# @description: The retention used in the backup script. This is used to delete
# old backups. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L573-L599)
#
# note:
# - The retention is based on the modification time of the file.
# - Default retention is 7 days. This can be changed by setting the `-r` variable.
#   - example: `-r 14` would set the retention to 14 days.
# - The retention path options are used to exclude directories from the retention.
# - Default retention paths are /backup/files/ and /backup/databases/. These can
# be changed by setting the `-fdbu` and `-dbdbu` variables.
#   - example: `-fdbu /backup/files/backup/` would create and set the file retention
# path to /backup/files/backup/.
#
# @break
# shellcheck disable=SC2035,SC2086,SC2061
##################################################################################
vstacklet::backup::retention() {
	vstacklet::shell::text::white "Checking retention..."
	# Set the retention options.
	# find files older than 7 days and delete them
	[[ -n "${FILE}" ]] && find "${FILE_RETENTION_PATH:-${F_DIR_DEST:-/backup/files/}}" -type f -name *.${FILE_RETENTION_PATH_EXTENSION} -mtime +${RETENTION} -exec rm -f {} \;
	[[ -n "${DB}" ]] && find "${DB_RETENTION_PATH:-${DB_DIR_DEST:-/backup/databases/}}" -type f -name *.${DB_RETENTION_PATH_EXTENSION} -mtime +${RETENTION} -exec rm -f {} \;
	# Check if the retention succeeded.
	#if [[ "${?}" -eq 0 ]]; then
	if [[ -z "$(find "${FILE_RETENTION_PATH:-${F_DIR_DEST:-/backup/files/}}" -type f -name *.${FILE_RETENTION_PATH_EXTENSION} -mtime +${RETENTION})" ]] && [[ -z "$(find "${DB_RETENTION_PATH:-${DB_DIR_DEST:-/backup/databases/}}" -type f -name *.${DB_RETENTION_PATH_EXTENSION} -mtime +${RETENTION})" ]]; then
		vstacklet::shell::text::success "The retention was successful!"
		vstacklet::shell::misc::nl
		# Long listing of files in files and database backup directories to check file sizes.
		if [[ -n "${FILE}" ]]; then
			vstacklet::shell::text::white "The following files remain in ${F_DIR_DEST}:"
			ls -lh "${F_DIR_DEST:-/backup/files/}"
			vstacklet::shell::misc::nl
		fi
		if [[ -n "${DB}" ]]; then
			vstacklet::shell::text::white "The following files remain in ${DB_DIR_DEST}:"
			ls -lh "${DB_DIR_DEST:-/backup/databases/}"
			vstacklet::shell::misc::nl
		fi
	else
		vstacklet::shell::text::error "The retention failed!"
		vstacklet::shell::misc::nl
	fi
}

##################################################################################
# @name: vstacklet::outro (10)
# @description: Prints the outro message. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L606-L611)
# @break
##################################################################################
vstacklet::outro() {
	vstacklet::shell::text::success "Backup complete!"
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "Thank you for using the vStacklet Backup Utility."
	vstacklet::shell::misc::nl
}

##################################################################################
# @name: vstacklet::backup::usage
# @description: Display the usage of the backup script. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L618-L659)
# @break
##################################################################################
vstacklet::backup::usage() {
	vstacklet::shell::text::white "Usage: ${0} [OPTION]..."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "Backup specified database to a local directory."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "Options:"
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -h, --help"
	vstacklet::shell::text::white "    Display this help message."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -V, --version"
	vstacklet::shell::text::white "    Display the version of this script."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -db, --database"
	vstacklet::shell::text::white "    The database to backup."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -dbuser, --database_user"
	vstacklet::shell::text::white "    The database user to use for the backup."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -dbpass, --database_password"
	vstacklet::shell::text::white "    The database password to use for the backup."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -dbtbu, --database_temporary_directory"
	vstacklet::shell::text::white "    The temporary backup directory to use for the backup."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -dbdbu, --database_backup_directory"
	vstacklet::shell::text::white "    The destination backup directory to use for the backup."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -ftbu, --file_temporary_directory"
	vstacklet::shell::text::white "    The temporary backup directory to use for the backup."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -fdbu, --file_backup_directory"
	vstacklet::shell::text::white "    The destination backup directory to use for the backup."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -f, --file"
	vstacklet::shell::text::white "    The file/directory to backup."
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  -r, --retention"
	vstacklet::shell::text::white "    The retention to use for the backup."
	vstacklet::shell::misc::nl
	exit 0
}

##################################################################################
# @name: vstacklet::backup::example_cron
# @description: Example cron job for the backup script. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L666-L674)
# @break
##################################################################################
vstacklet::backup::example_cron() {
	vstacklet::shell::text::white "Example Cron Job:"
	vstacklet::shell::misc::nl
	vstacklet::shell::text::white "  # Example Schedule"
	vstacklet::shell::text::white "  # Run Directory and Database Backup Daily @ 12:30 AM"
	vstacklet::shell::text::white "  30 00 * * * root /opt/vstacklet/bin/backup/vs-backup -db \"db_name\" -dbuser \"db_user\" -dbpass \"db_pass\" -dbtbu \"/tmp/vstacklet/backup/databases/\" -dbdbu \"/backup/databases/\" -ftbu \"/tmp/vstacklet/backup/files/\" -fdbu \"/backup/files/\" -f \"/var/www/html/\""
	vstacklet::shell::misc::nl
	exit 0
}

##################################################################################
# @name: vstacklet::backup::version
# @description: Display the version of the backup script. [see function](https://github.com/JMSDOnline/vstacklet/blob/development/bin/backup/vs-backup#L681-L687)
# @break
##################################################################################
vstacklet::backup::version() {
	# set the version of the backup script
	VERSION="$(grep -E '^# @version:' "/opt/vstacklet/bin/backup/vs-backup" | awk '{print $3}')"
	vstacklet::shell::text::white "vStacklet Backup Utility v${VERSION}"
	vstacklet::shell::misc::nl
	exit 0
}

################################################################################
# @description: Calls functions in required order.
# @break
################################################################################
vstacklet::environment::checkroot               #(1)
vstacklet::environment::functions               #(2)
vstacklet::backup::variables "${@}"             #(3)
vstacklet::backup::default::variables           #(4)
vstacklet::backup::main::checks                 #(5)
vstacklet::intro                                #(6)
[[ -n "${FILE}" ]] && vstacklet::backup::files  #(7)
[[ -n "${DB}" ]] && vstacklet::backup::database #(8)
vstacklet::backup::retention                    #(9)
vstacklet::outro                                #(10)
